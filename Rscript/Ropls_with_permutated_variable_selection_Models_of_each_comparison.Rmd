---
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
mathjax: null
params:
  group1: "tomt"
  group2: "tomt"
  secID: "tomt"
  pcorr_Model1: 0
  ortho_pre_vs_Model1: 0
  ortho_post_vs_Model1: 0
  setseedno: 0
  p_pearson_of_pcorr_cutoff: 0
  directory_input_matrix_sampleID: "tomt"
  filename_matrix: "tomt"
  decimal_separator: "tomt"
  variable_names_length: 0
  variable_names_position: "tomt"
  filename_sampleID: "tomt"
  directory_output_reports: "tomt"
  projectname: "tomt"
  date_of_analysis: 0
  no_permutations_post_vs: 0
  no_permutations_post_vs_selected_models: 0
  no_permutations_pre_vs: 0
  colname_groupID: "tomt"
  colname_secID: "tomt"
  filter_percent_in_each_group: 0
  directory_and_filename_function_file: "tomt"
  max_no_of_ortho_pre_vs_in_Model2: 0
  max_no_of_ortho_pre_vs_in_Model3_and_Model4: 0
  max_no_of_ortho_post_vs_in_Model2: 0
  max_no_of_ortho_post_vs_in_Model3_and_Model4: 0
  prefered_pR2_and_pQ2_permutated_post_vs: 0
  reordered_levels_of_groups: 0
  pcorr_diff: 0
  variable_selection_using_VIP: "tomt"

---

---
title: |
    | ROPLS models `r gsub("_"," ",paste(params$projectname))`
    | Model of group `r group1` versus `r group2` for `r secID`
 
author: |
    | Ropls with permutated variable selection: Version 11
    | Marika Strom
date: `r Sys.Date()`
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, error=TRUE, fig.fullwidth=TRUE)
#opts_chunk$set sets the parameters for the whole document
```

```{r, echo=FALSE}

library("ropls")
library("ggplot2")
library("ggrepel")
library(kableExtra)
library(gridExtra)
library("ggpubr")
library("matrixStats")
library(stringr)
library(tryCatchLog)
library(DescTools)
```

```{r echo=FALSE}

group1 <- params$group1
group2 <- params$group2
secID <- params$secID
pcorr_Model1<- params$pcorr_Model1
ortho_pre_vs_Model1<-params$ortho_pre_vs_Model1
ortho_post_vs_Model1<-params$ortho_post_vs_Model1
setseedno<-params$setseedno
p_pearson_of_pcorr_cutoff<-params$p_pearson_of_pcorr_cutoff
directory_input_matrix_sampleID<-params$directory_input_matrix_sampleID
filename_matrix<-params$filename_matrix
decimal_separator<-params$decimal_separator
variable_names_length<-params$variable_names_length
variable_names_position<-params$variable_names_position
filename_sampleID<-params$filename_sampleID
directory_output_reports<-params$directory_output_reports
projectname<-params$projectname
date_of_analysis<-params$date_of_analysis
no_permutations_post_vs<-params$no_permutations_post_vs
no_permutations_post_vs_selected_models<-params$no_permutations_post_vs_selected_models
no_permutations_pre_vs<-params$no_permutations_pre_vs
colname_groupID<-params$colname_groupID
colname_secID<-params$colname_secID
filter_percent_in_each_group<-params$filter_percent_in_each_group
directory_and_filename_function_file<-params$directory_and_filename_function_file
max_no_of_ortho_pre_vs_in_Model2<-params$max_no_of_ortho_pre_vs_in_Model2
max_no_of_ortho_pre_vs_in_Model3_and_Model4<-params$max_no_of_ortho_pre_vs_in_Model3_and_Model4
max_no_of_ortho_post_vs_in_Model2<-params$max_no_of_ortho_post_vs_in_Model2
max_no_of_ortho_post_vs_in_Model3_and_Model4<-params$max_no_of_ortho_post_vs_in_Model3_and_Model4
prefered_pR2_and_pQ2_permutated_post_vs<-params$prefered_pR2_and_pQ2_permutated_post_vs
reordered_levels_of_groups<-params$reordered_levels_of_groups
pcorr_diff<-params$pcorr_diff
variable_selection_using_VIP<-params$variable_selection_using_VIP

directory_and_filename_rdata <- paste(paste(directory_output_reports, projectname, sep=""), date_of_analysis, group1, "vs", group2, secID,".Rdata", sep="_")
filename_rdata <- paste(projectname, date_of_analysis, group1, "vs", group2, secID,".Rdata", sep="_")
source(directory_and_filename_function_file)

```

##Data to analysis

```{R loading data}
#Loading matrix and metadata

directory_and_filename_input_matrix <- paste(directory_input_matrix_sampleID,"/",filename_matrix,sep="")
directory_and_filename_sampleID <- paste(directory_input_matrix_sampleID,"/",filename_sampleID,sep="")

  # read datamatrix
if (decimal_separator=="dot"){
  datamatrix <- read.csv(directory_and_filename_input_matrix, header=T, dec = ".", row.names=1, check.names = FALSE, na.strings=c("", "NA", "Inf"), sep="\t")
} else {
datamatrix <- read.csv(directory_and_filename_input_matrix, header=T, dec = ",", row.names=1, check.names = FALSE, na.strings=c("", "NA", "Inf"), sep="\t")  
}

  #Read meta data with sample and peptide information for annotation####
if (decimal_separator=="dot"){
  sampleID <- read.table(directory_and_filename_sampleID,header=T, dec = ".", row.names=1, check.names = FALSE, na.strings=c("", "NA", "Inf"), sep="\t")
} else {
   sampleID <- read.table(directory_and_filename_sampleID,header=T, dec = ",", row.names=1, check.names = FALSE, na.strings=c("", "NA", "Inf"), sep="\t")
}
  

```

Project name: `r projectname`

Date of analysis: `r as.character(date_of_analysis)`

Directory data matrix and sample id: `r directory_input_matrix_sampleID`

Filename data matrix: `r filename_matrix`

Filname sample id: `r filename_sampleID`

Directory and file name function file: `r directory_and_filename_function_file`

Directory output reports: `r directory_output_reports`

File name rdata: `r filename_rdata`

Permutations before variable selection in selected models: `r no_permutations_pre_vs`

Permutations after variable selection during model selection: `r no_permutations_post_vs`

Permutations after variable selection in selected models: `r no_permutations_post_vs_selected_models`

Missing value tolerance in each group: `r filter_percent_in_each_group`

Model: group `r group1` vs group `r group2` for `r secID`

max number of orthogonal variables in model pre variable selection in Model 2: `r max_no_of_ortho_pre_vs_in_Model2`

max number of orthogonal variables in model pre variable selection in Model 3 and 4: `r max_no_of_ortho_pre_vs_in_Model3_and_Model4`

max number of orthogonal variables in model post variable selection in model 2: `r max_no_of_ortho_post_vs_in_Model2`

max number of orthogonal variables in model post variable selection in model 3 and 4: `r max_no_of_ortho_post_vs_in_Model3_and_Model4`

prefered pR2 and pQ2 during model selection permutated post variable selection: `r prefered_pR2_and_pQ2_permutated_post_vs`

pcorr increase allowing Q2 to decrease 1% during model selection in Model4: `r pcorr_diff`

variable selection method: `r if(variable_selection_using_VIP=="yes") {paste("Using p(corr) and VIP")} else {paste("Using p(corr)")}`

```{R subset sampleID and matrix, error=FALSE}

## subset sampleID and matrix

 subsetdatamatrix <- subsetmatrixfunction(sampleID,datamatrix,group1,group2,secID)
 subsetsampleID <- subsetsampleIDfunction(sampleID,group1,group2,secID)
 class <- as.factor(subsetsampleID[,paste(colname_groupID)])
  classordered<-class
  inv_reordered_levels_of_groups <- rev(reordered_levels_of_groups)
  levels(classordered)<-inv_reordered_levels_of_groups
  for (i in 1:length(class)) {classordered[i]<-class[i]}
  classordered<-droplevels(classordered)
  
 subsetdatamatrixfiltered <- filterNAfunction(subsetsampleID,subsetdatamatrix,group1,group2,secID,filter_percent_in_each_group)
subsetdatamatrixfiltereddf <- as.data.frame(subsetdatamatrixfiltered)
subsetdatamatrixdummies <- subsetdatamatrixfiltereddf
tryCatch({
subsetdatamatrixdummies <- fastDummies::dummy_cols(subsetdatamatrixfiltereddf, remove_selected_columns=TRUE, ignore_na=TRUE)
rownames(subsetdatamatrixdummies)<-rownames(subsetdatamatrixfiltereddf)
},error = function(e){rownames(subsetdatamatrixdummies)<-rownames(subsetdatamatrixfiltereddf)})

subsetdatamatrix <- subsetdatamatrixdummies
for (i in 1:ncol(subsetdatamatrix)){
  subsetdatamatrix[,i] <- as.numeric(subsetdatamatrix[,i])
}

tsubsetdatamatrix <- t(subsetdatamatrix)
set.seed(setseedno)

```

subject number group `r group1`: `r ngroup1 <- nrow(subset(subsetsampleID,subsetsampleID[,paste(colname_groupID)]==group1)); ngroup1`

subject number group `r group2`: `r ngroup2 <- nrow(subset(subsetsampleID,subsetsampleID[,paste(colname_groupID)]==group2)); ngroup2`

no of variables before filtering: `r no_of_variables_before_filtering <- ncol(datamatrix); no_of_variables_before_filtering`

no of variables after filtering: `r no_of_variables_after_filtering <- ncol(subsetdatamatrixfiltereddf); no_of_variables_after_filtering`

no of expanded variables after filtering: `r no_of_expanded_variables_after_filtering <- ncol(subsetdatamatrixdummies); no_of_expanded_variables_after_filtering`


   

```{R}

if (pcorr_Model1=="according to p-value"){
pcorr <- calculatepcorrfrompvalue(selectpvalue=p_pearson_of_pcorr_cutoff,n=nrow(subsetsampleID))
} else {
  pcorr <- pcorr_Model1
}

```
##PCA 
###all subjects included in comparison
```{R}

plot(opls(subsetdatamatrix,typeVc = "x-score",info.txtC="none", fig.pdfC="none"), parAsColFcVn = classordered)
```

###Subjects in `r group1`

```{R}
subsetdatamatrix_group1 <- subset(subsetdatamatrix, subsetsampleID$Diagnos==group1)
opls(subsetdatamatrix_group1,typeVc = "x-score",info.txtC="none")
```

###Subjects in `r group2`

```{R}
subsetdatamatrix_group2 <- subset(subsetdatamatrix, subsetsampleID$Diagnos==group2)
opls(subsetdatamatrix_group2,typeVc = "x-score",info.txtC="none")

```

#Model 1. Models with userset p(corr) cutoff during variable selection and userset number of orthogonal variables pre and post variable selection

###Model descripton
Model post variable selection using p(corr) cutoff `r paste(pcorr); if(pcorr_Model1=="according to p-value"){paste(" which correspond to p-value ", p_pearson_of_pcorr_cutoff)}` and has `r ortho_pre_vs_Model1` orthogonals in model pre variable selection and `r ortho_post_vs_Model1` orthogonals in model post variable selection


```{R Model using set pcorr cutoff or from p-value and set amount orthogonal}

    ortho_pre_vs <- ortho_pre_vs_Model1
    ortho_post_vs <- ortho_post_vs_Model1
    
testvariablename <- "result_Model1"
testvariable <- exist_in_rdata(testvariablename, filename_rdata, directory_output_reports, directory_and_filename_rdata)
if (!is.null(testvariable)){result_Model1 <- testvariable} else {

result_Model1 <- 
  opls_model_with_variable_selection_trycatch(
    subsetdatamatrix,
    ortho_pre_vs,
    ortho_post_vs,
    class=classordered, 
    pcorr,printoptmodel="none",
    plotoptmodel="none",
    no_permutations_post_vs=no_permutations_post_vs_selected_models,
    variable_selection_using_VIP
  )
}

```
###Model pre variable selection

```{R}
result_pre_vs <- result_Model1$beforevsdata.oplsda@summaryDF
colnames(result_pre_vs)[6] <- "ortho pre v.s."
kable(result_pre_vs, row.names = T) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

```

###Model statistics

```{R}
  
kable(result_Model1$resultaftervs, row.names = T) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

plot(result_Model1$aftervsdata.oplsda, typeVc= c("overview"))
     
if (ortho_post_vs>0) {
  plot(result_Model1$aftervsdata.oplsda, typeVc= c("outlier"))
  }
     
```

###Score plots

```{R}

if (ortho_post_vs>0) {
       plot(result_Model1$aftervsdata.oplsda, typeVc= c("x-score"))
     }

plotscore(result_Model1)

plotboxplot(result_Model1)


```

###Loading plots

```{R}

if (ortho_post_vs>0) {
       plot(result_Model1$aftervsdata.oplsda, typeVc= c("x-loading"))
     }

plotpcorr(result_Model1, variable_names_length, variable_names_position) 

if (length(result_Model1$pcorrlistaftervs$pcorrlistaftervs)>=50) {
  plotpcorronly50variables(result_Model1, variable_names_length, variable_names_position)
}

```

###Permutation after variable selection

```{R}

plot(result_Model1$aftervsdata.oplsda, typeVc= c("permutation"))

```

###Permutation before variable selection
Subjects were permutated and variable selection performed using p(corr) cutoff `r pcorr` corresponding to p-value `r p_pearson_of_pcorr_cutoff`,  with `r ortho_pre_vs_Model1` orthogonal variables in model pre varibale selection and `r ortho_post_vs_Model1` orthogonal variables in model post variable selection

####Table of permutation

```{R permutation of model using set pcorr or from p-value and set amount orthogonal}

testvariablename <- "permutated_models_Model1"
testvariable <- exist_in_rdata(testvariablename, filename_rdata, directory_output_reports, directory_and_filename_rdata)
if (!is.null(testvariable)){permutated_models_Model1 <- testvariable} else {

permutated_models_Model1 <- 
  table_of_randomised_models_before_vs(
    subsetdatamatrix,
    ortho_pre_vs,
    ortho_post_vs,
    class=classordered, 
    pcorr,
    no_permutations_pre_vs,
    variable_selection_using_VIP
  )
}

for (l in 1:nrow(permutated_models_Model1)){
if (is.na(permutated_models_Model1$`Q2(cum)`[l])| permutated_models_Model1$`Q2(cum)`[l]< (-1)) { 
       permutated_models_Model1$`Q2(cum)`[l] <- 0
      }
}

kable(permutated_models_Model1) %>%
  kable_styling() %>%
  scroll_box(width = "fullwidth", height = "300px")

```

 
####Percentage of R2 and Q2 in permutated model larger than R2 and Q2 in unpermutated model

```{R}


percent_R2_and_Q2_in_permutated_larger_than_in_unpermutated_Model1 <-
percent_R2_and_Q2_in_permutated_larger_than_in_unpermutated(
  permutated_models_Model1,
  result_Model1$resultaftervs$`R2Y(cum)`,
  result_Model1$resultaftervs$`Q2(cum)`
)

pvalue_R2_and_Q2_in_perm_Model1 <-
pvalue_R2_and_Q2_in_perm(
  permutated_models_Model1,
  result_Model1$resultaftervs$`R2Y(cum)`,
  result_Model1$resultaftervs$`Q2(cum)`
)

percentage_and_pvalue_perm_Model1 <- as.data.frame(cbind(percent_R2_and_Q2_in_permutated_larger_than_in_unpermutated_Model1,row.names(pvalue_R2_and_Q2_in_perm_Model1),pvalue_R2_and_Q2_in_perm_Model1[,1]))

colnames(percentage_and_pvalue_perm_Model1) <- NULL
kable(percentage_and_pvalue_perm_Model1, row.names = T) %>%
  kable_styling(bootstrap_options = "striped", full_width = F,position = "left")


```

####Plot of permutations before variable selection

```{R  plot permutation of model using set pcorr or from p-value and set amount orthogonal, fig.height = 10}

plotpermutationswithoriginalmodelandreg(permutated_models_Model1, subsetdatamatrix, ortho_pre_vs, ortho_post_vs,class=classordered,pcorr,variable_selection_using_VIP)

pcorr <- calculatepcorrfrompvalue(selectpvalue=p_pearson_of_pcorr_cutoff,n=nrow(subsetsampleID))

```

#Model 2. Model with p(corr) cutoff corresponding to userset pvalue cutoff for correlation

Selecting model with variable selection using p(corr) cutoff `r pcorr` corresponding to p-value `r p_pearson_of_pcorr_cutoff`

##Optimizing model

###Investigating amount of orthogonal variables in model pre variable selection

####Table of model pre variable selection with different amount of orthogonal variables in model pre variable selection

```{R table model pre variable selection pcorr from pvalue}
testvariablename <- "table_different_amount_of_ortho_pre_vs_Model2"
testvariable <- exist_in_rdata(testvariablename, filename_rdata, directory_output_reports, directory_and_filename_rdata)
if (!is.null(testvariable)){table_different_amount_of_ortho_pre_vs_Model2 <- testvariable} else {
  
table_different_amount_of_ortho_pre_vs_Model2 <-
  model_pre_vs_with_different_amount_of_ortho_pre_vs_table(
    subsetdatamatrix, 
    no_of_orthogonal_in_model_pre_vs=5, 
    class=classordered,
    no_permutations_post_vs,
    variable_selection_using_VIP
  )
}


kable(table_different_amount_of_ortho_pre_vs_Model2, row.names = T) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

no_orto_original_with_max_Q2 <- 
  subset(
    table_different_amount_of_ortho_pre_vs_Model2,
    table_different_amount_of_ortho_pre_vs_Model2$`Q2(cum)`==max(table_different_amount_of_ortho_pre_vs_Model2$`Q2(cum)`)
  )

no_orto_original_with_max_Q2 <- subset(no_orto_original_with_max_Q2,!duplicated(no_orto_original_with_max_Q2$`Q2(cum)`))



```
#### Plot of model pre variable selection with different amount of orthogonal variables in model pre variable selection showing differences between R2Y(cum) and Q2(cum) versus Q2(cum)
```{R plot of model pre variable selection pcorr from pvalue}

plotof_model_pre_vs_with_different_amount_of_ortho_pre_vs(
  table_different_amount_of_ortho_pre_vs_Model2
)

```

`r no_orto_original_with_max_Q2$ort` orthogonal latent variables in model pre variable selection give model pre variable selection with highest Q2


```{R table post variable selection pcorr from pvalue}
###  Table of model post variable selection with different amount of orthogonal variables in model pre variable selection

testvariablename <- "table_model_post_vs_different_amount_of_ort_in_model_pre_vs_Model2"
testvariable <- exist_in_rdata(testvariablename, filename_rdata, directory_output_reports, directory_and_filename_rdata)
if (!is.null(testvariable)){table_model_post_vs_different_amount_of_ort_in_model_pre_vs_Model2 <- testvariable} else {

table_model_post_vs_different_amount_of_ort_in_model_pre_vs_Model2 <-
  model_post_vs_with_different_amount_of_ortho_pre_vs_table(
    subsetdatamatrix, 
    no_of_orthogonal_in_model_pre_vs=15,
    ortho_post_vs=0,
    class=classordered, 
    pcorr=pcorr,
    no_permutations_post_vs=no_permutations_post_vs,
    variable_selection_using_VIP
  )
}

no_orto_original_with_max_Q2_and_diff_less_than_02 <-
  selecting_model_with_diff_less_than_02_and_max_Q2(
    table_model_post_vs_different_amount_of_ort_in_model_pre_vs_Model2, prefered_pR2_and_pQ2_permutated_post_vs)

```
#### Plot of model post variable selection with different amount of orthogonal variables in model pre variable selection showing difference between R2Y(cum) and Q2(cum) versus Q2(cum)
```{R plot models post variable selection pcorr from pvalue}

plotof_model_post_vs_with_different_amount_of_ortho_pre_vs(
  table_model_post_vs_different_amount_of_ort_in_model_pre_vs_Model2
)

```

`r no_orto_original_with_max_Q2_and_diff_less_than_02$"ortho pre v.s."` orthogonal latent variables in model pre variable selection give model post variable selection with highest Q2 and lowest R2-Q2 in model post variable selection when 0 orthogonal variables are used in model post variable selection

###Selecting amount of orthogonal variables in model pre variable selection and in model post variable selection

####  Table of model post variable selection with different amount of orthogonal variables in model pre variable selection and in model post variable selection 


```{R table of orthogonals model post variable selections pcorr from pvalue}

testvariablename <- "model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model2"
testvariable <- exist_in_rdata(testvariablename, filename_rdata, directory_output_reports, directory_and_filename_rdata)
if (!is.null(testvariable)){model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model2 <- testvariable} else {

model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model2 <- 
  model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs(
    subsetdatamatrix, 
    no_of_orthogonal_in_model_pre_vs=max_no_of_ortho_pre_vs_in_Model2, 
    no_of_orthogonal_in_model_post_vs=max_no_of_ortho_post_vs_in_Model2,
    class=classordered, 
    pcorr=pcorr,
    no_permutations_post_vs=no_permutations_post_vs,
    variable_selection_using_VIP
  )
}

kable(model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model2, row.names = T) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")


no_orto_in_model_pre_vs_and_in_model_post_vs_with_max_Q2_and_diff_less_than_02 <-
selecting_model_with_diff_less_than_02_max_Q2_low_pperm_and_few_orthogonals(
  model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model2, prefered_pR2_and_pQ2_permutated_post_vs)


```


#### Plot of model post variable selection with different amount of orthogonal variables in model pre variable selection and in model post variable selection showing difference between R2Y(cum) and Q2(cum) versus Q2(cum)
labels show amount of latent orthogonal variables in model (original,post variable selection)

```{R plot table of orthogonals models post variable selection pcorr from pvalue}

plotof_model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs(
  model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model2,no_orto_in_model_pre_vs_and_in_model_post_vs_with_max_Q2_and_diff_less_than_02
)

```

`r no_orto_in_model_pre_vs_and_in_model_post_vs_with_max_Q2_and_diff_less_than_02$"ortho pre v.s."` orthogonal latent variables in model pre variable selection and `r no_orto_in_model_pre_vs_and_in_model_post_vs_with_max_Q2_and_diff_less_than_02$"ortho post v.s."` in model post variable selection give model post variable selection with highest Q2 and lowest R2-Q2.

```{R}
ortho_pre_vs <- no_orto_in_model_pre_vs_and_in_model_post_vs_with_max_Q2_and_diff_less_than_02$"ortho pre v.s."

ortho_post_vs <- no_orto_in_model_pre_vs_and_in_model_post_vs_with_max_Q2_and_diff_less_than_02$"ortho post v.s."
ortho_pre_vs_Model2 <- ortho_pre_vs
ortho_post_vs_Model2 <- ortho_post_vs

```

###Iteration table
####Create iteration table continuously increasing p(corr) during variable selection and adding orthogonals only if it increases Q2 1% in the actual model (i.e. not concidering the total amount of orthogonals pre and post)

```{R iteration table pcorr from pvalue}
testvariablename <- "iterationtable_Model2"
testvariable <- exist_in_rdata(testvariablename, filename_rdata, directory_output_reports, directory_and_filename_rdata)
if (!is.null(testvariable)){iterationtable_Model2 <- testvariable} else {

iterationtable_Model2<-
  iterationtable(
  subsetdatamatrix,
  ortho_pre_vs<-0,
  ortho_post_vs<-0,
  class=classordered, 
  pcorrselectionsvector=c(seq(0.01,0.9,by=0.01)),
  no_permutations_post_vs=no_permutations_post_vs,
  variable_selection_using_VIP=variable_selection_using_VIP
) 
}
short_iterationtable_Model2 <- subset(iterationtable_Model2,!duplicated(iterationtable_Model2$"no. variables")&!is.na(iterationtable_Model2$"no. variables"))

kable(short_iterationtable_Model2, row.names = T) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")
```

##Best performing model using p(corr) cutoff corresponding to userset pvalue cutoff for correlation
###Model description
####Best performing model performing variable selection using p(corr) cutoff `r pcorr` corresponding to p-value `r p_pearson_of_pcorr_cutoff` has `r ortho_pre_vs` orthogonal in model pre variable selection and `r ortho_post_vs` orthogonal in model post variable selection before variable selection

```{R Best performing model using pcorr cutoff from p-value}

testvariablename <- "result_Model2"
testvariable <- exist_in_rdata(testvariablename, filename_rdata, directory_output_reports, directory_and_filename_rdata)
if (!is.null(testvariable)){result_Model2 <- testvariable} else {

result_Model2 <- 
  opls_model_with_variable_selection_trycatch(
    subsetdatamatrix,
    ortho_pre_vs,
    ortho_post_vs,
    class=classordered, 
    pcorr,printoptmodel="none",
    plotoptmodel="none",
    no_permutations_post_vs=no_permutations_post_vs_selected_models,
    variable_selection_using_VIP
  )
}

```
###Model pre variable selection

```{R}
result_pre_vs <- result_Model2$beforevsdata.oplsda@summaryDF
colnames(result_pre_vs)[6] <- "ortho pre v.s."
kable(result_pre_vs, row.names = T) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

plot(result_Model2$beforevsdata.oplsda , typeVc= c("overview"))

```

###Model statistics

```{R}

kable(result_Model2$resultaftervs, row.names = T) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

plot(result_Model2$aftervsdata.oplsda, typeVc= c("overview"))
     if (ortho_post_vs>0) {
plot(result_Model2$aftervsdata.oplsda, typeVc= c("outlier"))
  }
     
```

###Score plots

```{R}

if (ortho_post_vs>0) {
       plot(result_Model2$aftervsdata.oplsda, typeVc= c("x-score"))
     }

plotscore(result_Model2)

plotboxplot(result_Model2)

```

###Loading plots

```{R}

if (ortho_post_vs>0) {
       plot(result_Model2$aftervsdata.oplsda, typeVc= c("x-loading"))
     }

plotpcorr(result_Model2, variable_names_length, variable_names_position) 

if (length(result_Model2$pcorrlistaftervs$pcorrlistaftervs)>=50) {
  plotpcorronly50variables(result_Model2, variable_names_length, variable_names_position)
}



```

###Permutation after variable selection

```{R}

plot(result_Model2$aftervsdata.oplsda, typeVc= c("permutation"))

```

###Permutation before variable selection
Subjects were permutated and variable selection performed using p(corr) cutoff `r pcorr` corresponding to p-value `r p_pearson_of_pcorr_cutoff`,  with `r ortho_pre_vs` orthogonal in model pre variable selection and `r ortho_post_vs` orthogonal in model post variable selection

####Table of permutation

```{R permutation of best performing model pcorr from p-value}

testvariablename <- "permutated_models_Model2"
testvariable <- exist_in_rdata(testvariablename, filename_rdata, directory_output_reports, directory_and_filename_rdata)
if (!is.null(testvariable)){permutated_models_Model2 <- testvariable} else {

permutated_models_Model2 <- 
  table_of_randomised_models_before_vs(
    subsetdatamatrix,
    ortho_pre_vs,
    ortho_post_vs,
    class=classordered, 
    pcorr,
    no_permutations_pre_vs,
    variable_selection_using_VIP
  )
}

for (l in 1:nrow(permutated_models_Model2)){
if (is.na(permutated_models_Model2$`Q2(cum)`[l])| permutated_models_Model2$`Q2(cum)`[l]< (-1)) { 
       permutated_models_Model2$`Q2(cum)`[l] <- 0
      }
}

kable(permutated_models_Model2) %>%
  kable_styling() %>%
  scroll_box(width = "fullwidth", height = "300px")

```

 
####Percentage of R2 and Q2 in permutated model larger than R2 and Q2 in unpermutated model

```{R}

percent_R2_and_Q2_in_permutated_larger_than_in_unpermutated_Model2 <-
percent_R2_and_Q2_in_permutated_larger_than_in_unpermutated(
  permutated_models_Model2,
  result_Model2$resultaftervs$`R2Y(cum)`,
  result_Model2$resultaftervs$`Q2(cum)`
)

pvalue_R2_and_Q2_in_perm_Model2 <-
pvalue_R2_and_Q2_in_perm(
  permutated_models_Model2,
  result_Model2$resultaftervs$`R2Y(cum)`,
  result_Model2$resultaftervs$`Q2(cum)`
)

percentage_and_pvalue_perm_Model2 <- as.data.frame(cbind(percent_R2_and_Q2_in_permutated_larger_than_in_unpermutated_Model2,row.names(pvalue_R2_and_Q2_in_perm_Model2),pvalue_R2_and_Q2_in_perm_Model2[,1]))

colnames(percentage_and_pvalue_perm_Model2) <- NULL
kable(percentage_and_pvalue_perm_Model2, row.names = T) %>%
  kable_styling(bootstrap_options = "striped", full_width = F,position = "left")

```
####Plot permutations of best performing model with variable selection using p(corr) cutoff `r pcorr` corresponding to p-value `r p_pearson_of_pcorr_cutoff`

```{R  plot permutation best model pcorr from p-value, fig.height = 10}

plotpermutationswithoriginalmodelandreg(permutated_models_Model2, subsetdatamatrix, ortho_pre_vs, ortho_post_vs,class=classordered,pcorr, variable_selection_using_VIP)

```


#Model 3. Model with variable using p(corr) cutoff giving best performing model and less than userset p-value cutoff for pearson correlation 

Selecting model with variable selection using p(corr) which gives model with high Q2, low difference between R2 and Q2, low p-value for Q2 and corresponding to p-value for pearson correlation less than `r p_pearson_of_pcorr_cutoff`

##Model optimization

###P(corr) table, investigating different p(corr) cutoff

####Table of models after variable selection using different p(corr) cutoff and using `r ortho_pre_vs` orthogonal in model pre variable selection and `r ortho_post_vs` orthogonal in model post variable selection.

```{R table using different pcorr cutoff}
pcorr_corresponging_to_pvalue <- calculatepcorrfrompvalue(selectpvalue=p_pearson_of_pcorr_cutoff,n=nrow(subsetsampleID))

testvariablename <- "pcorr_table_of_model_post_vs"
testvariable <- exist_in_rdata(testvariablename, filename_rdata, directory_output_reports, directory_and_filename_rdata)
if (!is.null(testvariable)){pcorr_table_of_model_post_vs <- testvariable} else {

pcorr_table_of_model_post_vs <- pcorrtableofmodelsaftervs_withdiff(
  subsetdatamatrix, 
  ortho_pre_vs,
  ortho_post_vs,
  class=classordered,
  pcorrvector=c(seq(0.9,pcorr_corresponging_to_pvalue,by=-0.01),pcorr_corresponging_to_pvalue),
  no_permutations_post_vs=no_permutations_post_vs,
  variable_selection_using_VIP
)
}

short_pcorr_table_of_model_post_vs <- subset(pcorr_table_of_model_post_vs,!duplicated(pcorr_table_of_model_post_vs$"no. variables")&!is.na(pcorr_table_of_model_post_vs$"no. variables"))

kable(short_pcorr_table_of_model_post_vs, row.names = T) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

max_pcorrtable_with_max_Q2_and_diff_less_than_02_many_variables <-
selecting_model_with_diff_less_than_02_and_max_Q2(
    short_pcorr_table_of_model_post_vs, prefered_pR2_and_pQ2_permutated_post_vs)


pcorr <- max_pcorrtable_with_max_Q2_and_diff_less_than_02_many_variables$"pcorr cutoff"

```

#### Plot of p(corr) table of models post variable selection using different p(corr) cutoff showing models with different amount of variables versus Q2(cum).
Model using minimal amount of variables is indicated in red.

labels show pcorr cutoff in A and amount of variables in B

```{R plot pcorr table Model3}

plot_pcorrtable_amount_of_variables_with_pcorr_labels(
    short_pcorr_table_of_model_post_vs,max_pcorrtable_with_max_Q2_and_diff_less_than_02_many_variables)

```

###Selecting number of orthogonal variables in model pre variable selection and in model post variable selection

####  Table of models post variable selection with different amount of orthogonal variables in model pre variable selection and in model post variable selection using p(corr)=`r pcorr` giving highest Q2, lowest diff between R2 and Q2 and corresponding to p-value less than `r p_pearson_of_pcorr_cutoff`


```{R table of orthogonals models post variable selection pcorr cutoff from Q2}

testvariablename <- "model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model3"
testvariable <- exist_in_rdata(testvariablename, filename_rdata, directory_output_reports, directory_and_filename_rdata)
if (!is.null(testvariable)){model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model3 <- testvariable} else {

model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model3 <- 
  model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs(
    subsetdatamatrix, 
    no_of_orthogonal_in_model_pre_vs=max_no_of_ortho_pre_vs_in_Model3_and_Model4, 
    no_of_orthogonal_in_model_post_vs=max_no_of_ortho_post_vs_in_Model3_and_Model4,
    class=classordered, 
    pcorr=pcorr,
    no_permutations_post_vs=no_permutations_post_vs,
    variable_selection_using_VIP
  )
}

kable(model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model3, row.names = T) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

no_orto_in_model_pre_vs_and_in_model_post_vs_with_max_Q2_and_diff_less_than_02 <-
 selecting_model_with_diff_less_than_02_max_Q2_low_pperm_and_few_orthogonals(
    model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model3, prefered_pR2_and_pQ2_permutated_post_vs)


ortho_pre_vs <- no_orto_in_model_pre_vs_and_in_model_post_vs_with_max_Q2_and_diff_less_than_02$"ortho pre v.s."

ortho_post_vs <- no_orto_in_model_pre_vs_and_in_model_post_vs_with_max_Q2_and_diff_less_than_02$"ortho post v.s."

```
#### Plot of model post variable selection with different amount of orthogonal variables in model pre variable selection and in model post variable selection using p(corr)=`r pcorr` giving highest Q2 showing difference between R2Y(cum) and Q2(cum) versus Q2(cum)

labels show amount of latent orthogonal variables in model (original,post variable selection)
```{R plot table of orthogonals models post variable selection pcorr from Q2}

plotof_model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs(
  model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model3, no_orto_in_model_pre_vs_and_in_model_post_vs_with_max_Q2_and_diff_less_than_02
)

```

`r ortho_pre_vs` orthogonal latent variables in model pre variable selection and `r ortho_post_vs` in model post variable selection give model post variable selection with highest Q2 and lowest R2-Q2.

##Best performing model using p(corr) cutoff giving highest Q2
###Model description
####Best performing model with variable selection using p(corr) cutoff `r pcorr` with highest Q2 after variable selection resulted in `r ortho_pre_vs` orthogonal in model pre variable selection and `r ortho_post_vs` orthogonal in model post variable selection

```{R Best performing model pcorr highest Q2, fig.fullwidth=TRUE}

testvariablename <- "result_Model3"
testvariable <- exist_in_rdata(testvariablename, filename_rdata, directory_output_reports, directory_and_filename_rdata)
if (!is.null(testvariable)){result_Model3 <- testvariable} else {

result_Model3 <- 
  opls_model_with_variable_selection_trycatch(
    subsetdatamatrix,
    ortho_pre_vs,
    ortho_post_vs,
    class=classordered, 
    pcorr,
    printoptmodel="none",
    plotoptmodel="none",
    no_permutations_post_vs=no_permutations_post_vs_selected_models,
    variable_selection_using_VIP
  )
}

```
###Model pre variable selection

```{R}
result_pre_vs <- result_Model3$beforevsdata.oplsda@summaryDF
colnames(result_pre_vs)[6] <- "ortho pre v.s."
kable(result_pre_vs, row.names = T) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)


plot(result_Model3$beforevsdata.oplsda , typeVc= c("overview"))

```

###Model statistics

```{R}

kable(result_Model3$resultaftervs, row.names = T) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

plot(result_Model3$aftervsdata.oplsda, typeVc= c("overview"))
     if (ortho_post_vs>0) {
plot(result_Model3$aftervsdata.oplsda, typeVc= c("outlier"))
  }
     
```

###Score plots

```{R}

if (ortho_post_vs>0) {
       plot(result_Model3$aftervsdata.oplsda, typeVc= c("x-score"))
     }

plotscore(result_Model3)

plotboxplot(result_Model3)

```

###Loading plots

```{R}

if (ortho_post_vs>0) {
       plot(result_Model3$aftervsdata.oplsda, typeVc= c("x-loading"))
     }

plotpcorr(result_Model3, variable_names_length, variable_names_position)

if (length(result_Model3$pcorrlistaftervs$pcorrlistaftervs)>=50) {
  plotpcorronly50variables(result_Model3, variable_names_length, variable_names_position)
}

```

###Permutation after variable selection

```{R}

plot(result_Model3$aftervsdata.oplsda, typeVc= c("permutation"))

```


###Permutation before variable selection
Subjects were permutated and variable selection performed using p(corr) cutoff `r pcorr` with highest Q2 after variable selection and using `r ortho_pre_vs` orthogonal in model pre variable selection and `r ortho_post_vs` orthogonal in model post variable selection

####Table of permutations

```{R permutation of best model pcorr with highest Q2}

testvariablename <- "permutated_models_Model3"
testvariable <- exist_in_rdata(testvariablename, filename_rdata, directory_output_reports, directory_and_filename_rdata)
if (!is.null(testvariable)){permutated_models_Model3 <- testvariable} else {

permutated_models_Model3 <- 
  table_of_randomised_models_before_vs(
    subsetdatamatrix,
    ortho_pre_vs,
    ortho_post_vs,
    class=classordered, 
    pcorr,
    no_permutations_pre_vs,
    variable_selection_using_VIP
  )
}

for (l in 1:nrow(permutated_models_Model3)){
if (is.na(permutated_models_Model3$`Q2(cum)`[l])| permutated_models_Model3$`Q2(cum)`[l]< (-1)) { 
       permutated_models_Model3$`Q2(cum)`[l] <- 0
      }
}

kable(permutated_models_Model3) %>%
  kable_styling() %>%
  scroll_box(width = "fullwidth", height = "300px")

```

 
####Percentage of R2 and Q2 in permutated model larger than R2 and Q2 in unpermutated model

```{R}

percent_R2_and_Q2_in_permutated_larger_than_in_unpermutated_Model3 <-
percent_R2_and_Q2_in_permutated_larger_than_in_unpermutated(
  permutated_models_Model3,
  R2optimized=result_Model3$resultaftervs$`R2Y(cum)`,
  Q2optimized=result_Model3$resultaftervs$`Q2(cum)`)


pvalue_R2_and_Q2_in_perm_Model3 <-
pvalue_R2_and_Q2_in_perm(
  permutated_models_Model3,
  result_Model3$resultaftervs$`R2Y(cum)`,
  result_Model3$resultaftervs$`Q2(cum)`
)

percentage_and_pvalue_perm_Model3 <- as.data.frame(cbind(percent_R2_and_Q2_in_permutated_larger_than_in_unpermutated_Model3,row.names(pvalue_R2_and_Q2_in_perm_Model3),pvalue_R2_and_Q2_in_perm_Model3[,1]))

colnames(percentage_and_pvalue_perm_Model3) <- NULL
kable(percentage_and_pvalue_perm_Model3, row.names = T) %>%
  kable_styling(bootstrap_options = "striped", full_width = F,position = "left")


```
####Plot permutations of model with variable selection using p(corr) cutoff `r pcorr` with highest Q2 after variable selection and `r ortho_pre_vs` orthogonal in model pre variable selection and `r ortho_post_vs` orthogonal in model post variable selection

```{R plot permutation best model pcorr with highest Q2, fig.height = 10}

plotpermutationswithoriginalmodelandreg(permutated_models_Model3, subsetdatamatrix, ortho_pre_vs, ortho_post_vs,class=classordered,pcorr, variable_selection_using_VIP)

```

#Model 4. Model with p(corr) cutoff giving best performing model and corresponding to p-value for pearson correlation less than userset value and using minimal amount of variables

Model with variable selection using p(corr) corresponding to p-value less than `r p_pearson_of_pcorr_cutoff` which gives model with high Q2, low difference between R2 and Q2, low pQ2 post v.s. and using minimal amount of variables

##Optimizing model

###P(corr) table, investigating different p(corr) cutoff using minimal amount of variables

```{R}
ortho_pre_vs <- ortho_pre_vs_Model2
ortho_post_vs <- ortho_post_vs_Model2

```

####Table of models after variable selection using different p(corr) cutoff and using `r ortho_pre_vs` orthogonal in model pre variable selection, `r ortho_post_vs` orthogonal in model post variable selection and using minimal amount of variables.

```{R table using different pcorr cutoff for minimal amount of variables}
pcorr_corresponging_to_pvalue <- calculatepcorrfrompvalue(selectpvalue=p_pearson_of_pcorr_cutoff,n=nrow(subsetsampleID))

kable(short_pcorr_table_of_model_post_vs, row.names = T) %>%
  kable_styling(bootstrap_options = "striped", full_width = F, position = "left")

max_pcorrtable_with_max_Q2_and_diff_less_than_02_few_variables <-
    selecting_model_with_diff_less_than_02_max_Q2_low_pperm_and_high_pcorr_few_variables(
    short_pcorr_table_of_model_post_vs,
    prefered_pR2_and_pQ2_permutated_post_vs, pcorr_diff)


pcorr <- max_pcorrtable_with_max_Q2_and_diff_less_than_02_few_variables$"pcorr cutoff"

```
#### Plot of p(corr) table of models post variable selection using different p(corr) cutoff showing models with different amount of variables versus Q2(cum).
Model using minimal amount of variables is indicated in red.

labels show pcorr cutoff

```{R plot pcorr table few variables}

plot_pcorrtable_amount_of_variables_with_pcorr_labels(
    short_pcorr_table_of_model_post_vs,max_pcorrtable_with_max_Q2_and_diff_less_than_02_few_variables)

```

###Selecting amount of orthogonal variables in model pre variable selection and in model post variable selection

####  Table of models post variable selection with different amount of orthogonal variables in model pre variable selection and in model post variable selection using p(corr)=`r pcorr` giving highest Q2, lowest diff between R2 and Q2 and corresponding to p-value less than `r p_pearson_of_pcorr_cutoff` using minimal amount of variables


```{R table of orthogonals models post variable selection Model 4}
if (pcorr==result_Model3$resultaftervs$`pcorr cutoff`) {model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model4 <- model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model3} else {
testvariablename <- "model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model4"
testvariable <- exist_in_rdata(testvariablename, filename_rdata, directory_output_reports, directory_and_filename_rdata)
if (!is.null(testvariable)){model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model4 <- testvariable} else {

model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model4 <- 
  model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs(
    subsetdatamatrix, 
    no_of_orthogonal_in_model_pre_vs=max_no_of_ortho_pre_vs_in_Model3_and_Model4, 
    no_of_orthogonal_in_model_post_vs=max_no_of_ortho_post_vs_in_Model3_and_Model4,
    class=classordered, 
    pcorr=pcorr,
    no_permutations_post_vs=no_permutations_post_vs,
    variable_selection_using_VIP
  )
}
}

kable(model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model4, row.names = T) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

no_orto_in_model_pre_vs_and_in_model_post_vs_with_max_Q2_and_diff_less_than_02_few_variables <-
  selecting_model_with_diff_less_than_02_max_Q2_low_pperm_and_few_orthogonals(
    model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model4, prefered_pR2_and_pQ2_permutated_post_vs)


ortho_pre_vs <- no_orto_in_model_pre_vs_and_in_model_post_vs_with_max_Q2_and_diff_less_than_02_few_variables$"ortho pre v.s."

ortho_post_vs <- no_orto_in_model_pre_vs_and_in_model_post_vs_with_max_Q2_and_diff_less_than_02_few_variables$"ortho post v.s."

```
#### Plot of model post variable selection with different amount of orthogonal variables in model pre variable selection and in model post variable selection using p(corr)=`r pcorr` giving highest Q2 while using minimal amount of variables showing difference between R2Y(cum) and Q2(cum) versus Q2(cum)

labels show amount of latent orthogonal variables in model (original,post variable selection)
```{R plot table of no ortho of models post v.s. Model4}

plotof_model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs(
  model_post_vs_table_with_different_amount_of_ortho_pre_and_post_vs_Model4, no_orto_in_model_pre_vs_and_in_model_post_vs_with_max_Q2_and_diff_less_than_02_few_variables
)

```

`r ortho_pre_vs` orthogonal latent variables in model pre variable selection and `r ortho_post_vs` in model post variable selection give model post variable selection with highest Q2 and lowest R2-Q2.

##Best performing model using p(corr) cutoff giving highest Q2 using minimal amount of variables
###Model description
####Best performing model with variable selection using p(corr) cutoff `r pcorr` with highest Q2  using minimal amount of variables after variable selection resulted in `r ortho_pre_vs` orthogonal in model pre variable selection and `r ortho_post_vs` orthogonal in model post variable selection

```{R Best performing Model 4, fig.fullwidth=TRUE}

testvariablename <- "result_Model4"
testvariable <- exist_in_rdata(testvariablename, filename_rdata, directory_output_reports, directory_and_filename_rdata)
if (!is.null(testvariable)){result_Model4 <- testvariable} else {

result_Model4 <- 
  opls_model_with_variable_selection_trycatch(
    subsetdatamatrix,
    ortho_pre_vs,
    ortho_post_vs,
    class=classordered, 
    pcorr,
    printoptmodel="none",
    plotoptmodel="none",
    no_permutations_post_vs=no_permutations_post_vs_selected_models,
    variable_selection_using_VIP
  )
}

```
###Model pre variable selection

```{R}
result_pre_vs <- result_Model4$beforevsdata.oplsda@summaryDF
colnames(result_pre_vs)[6] <- "ortho pre v.s."
kable(result_pre_vs, row.names = T) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)


plot(result_Model4$beforevsdata.oplsda , typeVc= c("overview"))

```

###Model statistics

```{R}

kable(result_Model4$resultaftervs, row.names = T) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

plot(result_Model4$aftervsdata.oplsda, typeVc= c("overview"))
     if (ortho_post_vs>0) {
plot(result_Model4$aftervsdata.oplsda, typeVc= c("outlier"))
  }
     
```

###Score plots

```{R}

if (ortho_post_vs>0) {
       plot(result_Model4$aftervsdata.oplsda, typeVc= c("x-score"))
     }

plotscore(result_Model4)

plotboxplot(result_Model4)

```

###Loading plots

```{R}

if (ortho_post_vs>0) {
       plot(result_Model4$aftervsdata.oplsda, typeVc= c("x-loading"))
     }

plotpcorr(result_Model4, variable_names_length, variable_names_position)

if (length(result_Model4$pcorrlistaftervs$pcorrlistaftervs)>=50) {
  plotpcorronly50variables(result_Model4, variable_names_length, variable_names_position)
}

```

###Permutation after variable selection

```{R}

plot(result_Model4$aftervsdata.oplsda, typeVc= c("permutation"))

```


###Permutation before variable selection
Subjects were permutated and variable selection performed using p(corr) cutoff `r pcorr` with highest Q2 after variable selection using minimal amount of variables and using `r ortho_pre_vs` orthogonal in model pre variable selection and `r ortho_post_vs` orthogonal in model post variable selection

####Table of permutations

```{R permutation of best model Model 4}

if (result_Model4$resultaftervs$`pcorr cutoff`!=result_Model3$resultaftervs$`pcorr cutoff`) {
testvariablename <- "permutated_models_Model4"
testvariable <- exist_in_rdata(testvariablename, filename_rdata, directory_output_reports, directory_and_filename_rdata)
if (!is.null(testvariable)){permutated_models_Model4 <- testvariable} else {

permutated_models_Model4 <- 
  table_of_randomised_models_before_vs(
    subsetdatamatrix,
    ortho_pre_vs,
    ortho_post_vs,
    class=classordered, 
    pcorr,
    no_permutations_pre_vs,
    variable_selection_using_VIP
  )
}
} else {permutated_models_Model4 <- permutated_models_Model3}

for (l in 1:nrow(permutated_models_Model4)){
if (is.na(permutated_models_Model4$`Q2(cum)`[l])| permutated_models_Model4$`Q2(cum)`[l]< (-1)) { 
       permutated_models_Model4$`Q2(cum)`[l] <- 0
      }
}

kable(permutated_models_Model4) %>%
  kable_styling() %>%
  scroll_box(width = "fullwidth", height = "300px")

```

 
####Percentage of R2 and Q2 in permutated model larger than R2 and Q2 in unpermutated model

```{R}

percent_R2_and_Q2_in_permutated_larger_than_in_unpermutated_Model4 <-
percent_R2_and_Q2_in_permutated_larger_than_in_unpermutated(
  permutated_models_Model4,
  R2optimized=result_Model4$resultaftervs$`R2Y(cum)`,
  Q2optimized=result_Model4$resultaftervs$`Q2(cum)`)


pvalue_R2_and_Q2_in_perm_Model4 <-
pvalue_R2_and_Q2_in_perm(
  permutated_models_Model4,
  result_Model4$resultaftervs$`R2Y(cum)`,
  result_Model4$resultaftervs$`Q2(cum)`
)

percentage_and_pvalue_perm_Model4 <- as.data.frame(cbind(percent_R2_and_Q2_in_permutated_larger_than_in_unpermutated_Model4,row.names(pvalue_R2_and_Q2_in_perm_Model4),pvalue_R2_and_Q2_in_perm_Model4[,1]))

colnames(percentage_and_pvalue_perm_Model4) <- NULL
kable(percentage_and_pvalue_perm_Model4, row.names = T) %>%
  kable_styling(bootstrap_options = "striped", full_width = F,position = "left")


```
####Plot permutations of model with variable selection using p(corr) cutoff `r pcorr` with highest Q2 after variable selection  using minimal amount of variables and `r ortho_pre_vs` orthogonal in model pre variable selection and `r ortho_post_vs` orthogonal in model post variable selection

```{R plot permutation best model pcorr with highest Q2 using minimal amount of variables, fig.height = 10}

plotpermutationswithoriginalmodelandreg(permutated_models_Model4, subsetdatamatrix, ortho_pre_vs, ortho_post_vs,class=classordered,pcorr,variable_selection_using_VIP)



save.image(directory_and_filename_rdata)

rm(list=setdiff(ls(), c("model_table_to_analyse","filename_model_table_to_analyse","directory_model_table_to_analyse","projectname","date_of_analysis","directory_Rmarkdownfiles","filename_Rmarkdownfile_each_model","filename_Rmarkdownfile_summary","directory_input_matrix_sampleID","filename_matrix","decimal_separator","variable_names_length", "variable_names_position","filename_sampleID","colname_groupID","colname_secID","directory_output_reports","directory_and_filename_function_file","p_pearson_of_pcorr_cutoff","no_permutations_post_vs","no_permutations_post_vs_selected_models","no_permutations_pre_vs","filter_percent_in_each_group","directory_output_reports_and_projectname","groupsnumeric","max_no_of_ortho_pre_vs_in_Model2", "max_no_of_ortho_pre_vs_in_Model3_and_Model4","max_no_of_ortho_post_vs_in_Model2","max_no_of_ortho_post_vs_in_Model3_and_Model4","each_model_or_summary","prefered_pR2_and_pQ2_permutated_post_vs","cluster","reordered_levels_of_groups","pcorr_diff","variable_selection_using_VIP")))
```
